import React, { useState } from "react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle
} from "@/components/ui/dialog";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormDescription
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Popover, PopoverTrigger, PopoverContent } from "@/components/ui/popover";
import { Bell, BellOff, Settings, Check, AlertTriangle, Info } from "lucide-react";
import { useForm } from "react-hook-form";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { toast } from "@/hooks/use-toast";

interface NotificationItem {
  id: string;
  title: string;
  description: string;
  active: boolean;
  category: string;
  channels: {
    inApp: boolean;
    email: boolean;
    sms: boolean;
    chatInternal: boolean;
    push: boolean;
  };
  recipients: string[];
}

export const NotificationsTab = () => {
  const [activeTab, setActiveTab] = useState("inbox");
  const [editingNotification, setEditingNotification] = useState<NotificationItem | null>(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);

  // Mock data for notifications
  const notifications: NotificationItem[] = [
    // Inbox & Attendance notifications
    {
      id: "new-conversation",
      title: "Nova Conversa Recebida",
      description: "Notifica quando uma nova conversa é recebida e não está atribuída a ninguém",
      active: true,
      category: "inbox",
      channels: { inApp: true, email: true, sms: false, chatInternal: false, push: true },
      recipients: ["triageTeam"]
    },
    {
      id: "conversation-assigned",
      title: "Conversa Atribuída",
      description: "Notifica agentes quando uma conversa é atribuída a eles",
      active: true,
      category: "inbox",
      channels: { inApp: true, email: true, sms: false, chatInternal: false, push: true },
      recipients: ["assignedAgent"]
    },
    {
      id: "new-message-offline",
      title: "Nova Mensagem (Agente Offline)",
      description: "Notifica agentes sobre novas mensagens recebidas quando estão offline",
      active: true,
      category: "inbox",
      channels: { inApp: false, email: true, sms: false, chatInternal: false, push: true },
      recipients: ["assignedAgent", "teamManager"]
    },
    {
      id: "sla-first-response",
      title: "SLA de Primeira Resposta",
      description: "Alerta quando uma conversa está próxima de violar o SLA de primeira resposta",
      active: true,
      category: "inbox",
      channels: { inApp: true, email: false, sms: false, chatInternal: true, push: false },
      recipients: ["assignedAgent", "teamManager"]
    },
    
    // CRM notifications
    {
      id: "new-lead-assigned",
      title: "Novo Lead Atribuído ao Agente",
      description: "Notifica agentes quando um novo lead é atribuído a eles",
      active: true,
      category: "crm",
      channels: { inApp: true, email: true, sms: false, chatInternal: false, push: false },
      recipients: ["assignedAgent"]
    },
    {
      id: "task-due",
      title: "Tarefa Vencendo",
      description: "Notifica sobre tarefas que estão prestes a vencer",
      active: true,
      category: "crm",
      channels: { inApp: true, email: true, sms: false, chatInternal: false, push: false },
      recipients: ["taskOwner"]
    },
    {
      id: "deal-stage-changed",
      title: "Negócio Mudou de Etapa",
      description: "Notifica quando um negócio muda de etapa no funil de vendas",
      active: false,
      category: "crm",
      channels: { inApp: true, email: false, sms: false, chatInternal: true, push: false },
      recipients: ["dealOwner", "salesManager"]
    },
    
    // Marketing notifications
    {
      id: "campaign-started",
      title: "Campanha Iniciada",
      description: "Notifica quando uma campanha agendada começa a enviar mensagens",
      active: true,
      category: "marketing",
      channels: { inApp: true, email: false, sms: false, chatInternal: false, push: false },
      recipients: ["campaignCreator", "marketingTeam"]
    },
    {
      id: "campaign-completed",
      title: "Campanha Concluída",
      description: "Notifica quando uma campanha é concluída com métricas básicas",
      active: true,
      category: "marketing",
      channels: { inApp: true, email: true, sms: false, chatInternal: false, push: false },
      recipients: ["campaignCreator", "marketingTeam"]
    },
    
    // Goals notifications
    {
      id: "goal-progress",
      title: "Progresso de Meta",
      description: "Notifica quando o progresso de uma meta atinge marcos importantes",
      active: true,
      category: "goals",
      channels: { inApp: true, email: false, sms: false, chatInternal: true, push: false },
      recipients: ["goalOwner", "teamManager"]
    },
    {
      id: "goal-achieved",
      title: "Meta Alcançada",
      description: "Celebra quando uma meta individual ou de equipe é alcançada",
      active: true,
      category: "goals",
      channels: { inApp: true, email: false, sms: false, chatInternal: true, push: false },
      recipients: ["goalOwner", "teamManager", "recognitionPanel"]
    },
    
    // AI notifications
    {
      id: "ai-escalation",
      title: "Escalonamento da IA",
      description: "Notifica quando a IA Prof. Ana não consegue responder a uma pergunta",
      active: true,
      category: "ai",
      channels: { inApp: true, email: false, sms: false, chatInternal: true, push: false },
      recipients: ["aiSupportTeam"]
    },
    {
      id: "ai-negative-feedback",
      title: "Feedback Negativo da IA",
      description: "Notifica quando um usuário dá feedback negativo sobre uma resposta da IA",
      active: true,
      category: "ai",
      channels: { inApp: true, email: true, sms: false, chatInternal: false, push: false },
      recipients: ["aiAdministrators", "contentCurationTeam"]
    },
    
    // Admin notifications
    {
      id: "user-invited",
      title: "Usuário Convidado",
      description: "Notifica quando um novo usuário é convidado para a plataforma",
      active: true,
      category: "admin",
      channels: { inApp: true, email: false, sms: false, chatInternal: false, push: false },
      recipients: ["administrators"]
    },
    {
      id: "password-reset",
      title: "Senha Redefinida",
      description: "Notifica quando a senha de um usuário é redefinida",
      active: true,
      category: "admin",
      channels: { inApp: true, email: false, sms: false, chatInternal: false, push: false },
      recipients: ["administrators"]
    },
    {
      id: "payment-overdue",
      title: "Mensalidade Atrasada",
      description: "Notifica sobre mensalidades de alunos/clientes em atraso",
      active: true,
      category: "admin",
      channels: { inApp: true, email: true, sms: false, chatInternal: false, push: false },
      recipients: ["financialTeam"]
    },
    {
      id: "daily-activity-summary",
      title: "Resumo Diário de Atividades",
      description: "Envia um resumo diário das atividades para gestores",
      active: false,
      category: "admin",
      channels: { inApp: false, email: true, sms: false, chatInternal: false, push: false },
      recipients: ["managers"]
    }
  ];

  const handleEditNotification = (notification: NotificationItem) => {
    setEditingNotification(notification);
    setIsDialogOpen(true);
  };

  const handleToggleActive = (id: string, currentStatus: boolean) => {
    console.log(`Toggling notification ${id} to ${!currentStatus}`);
    toast({
      title: currentStatus ? "Notificação desativada" : "Notificação ativada",
      description: `A configuração foi atualizada com sucesso.`
    });
  };

  const handleCloseDialog = () => {
    setIsDialogOpen(false);
    setEditingNotification(null);
  };

  const handleSaveNotification = () => {
    if (!editingNotification) return;
    
    console.log("Salvando configurações da notificação:", editingNotification);
    toast({
      title: "Configurações salvas",
      description: "As configurações de notificação foram atualizadas com sucesso."
    });
    
    setIsDialogOpen(false);
    setEditingNotification(null);
  };

  const getRecipientLabel = (recipient: string): string => {
    const recipientMap: Record<string, string> = {
      "assignedAgent": "Agente responsável",
      "teamManager": "Gestor da equipe",
      "taskOwner": "Responsável pela tarefa",
      "dealOwner": "Proprietário do negócio",
      "salesManager": "Gestor de vendas",
      "campaignCreator": "Criador da campanha",
      "marketingTeam": "Equipe de marketing",
      "goalOwner": "Proprietário da meta",
      "recognitionPanel": "Painel de reconhecimento",
      "aiSupportTeam": "Equipe de suporte da IA",
      "aiAdministrators": "Administradores da IA",
      "contentCurationTeam": "Equipe de curadoria de conteúdo",
      "administrators": "Administradores",
      "managers": "Gestores",
      "financialTeam": "Equipe financeira",
      "triageTeam": "Equipe de triagem"
    };

    return recipientMap[recipient] || recipient;
  };

  const filteredNotifications = notifications.filter(
    (notification) => notification.category === activeTab
  );

  return (
    <Card>
      <CardHeader>
        <CardTitle>Configurações de Notificações</CardTitle>
        <CardDescription>
          Configure quais notificações o sistema enviará, seus destinatários e canais de comunicação
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue="inbox" value={activeTab} onValueChange={setActiveTab} className="space-y-6">
          <TabsList className="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-7">
            <TabsTrigger value="inbox">Caixa de Entrada</TabsTrigger>
            <TabsTrigger value="crm">CRM</TabsTrigger>
            <TabsTrigger value="marketing">Marketing</TabsTrigger>
            <TabsTrigger value="goals">Metas</TabsTrigger>
            <TabsTrigger value="ai">IA - Prof. Ana</TabsTrigger>
            <TabsTrigger value="admin">Administração</TabsTrigger>
            <TabsTrigger value="templates">Modelos</TabsTrigger>
          </TabsList>

          {["inbox", "crm", "marketing", "goals", "ai", "admin"].map((tabValue) => (
            <TabsContent key={tabValue} value={tabValue}>
              <div className="border rounded-md divide-y">
                {filteredNotifications.map((notification) => (
                  <div key={notification.id} className="p-4 flex items-center justify-between">
                    <div>
                      <h3 className="font-medium">{notification.title}</h3>
                      <p className="text-sm text-muted-foreground">
                        {notification.description}
                      </p>
                    </div>
                    <div className="flex items-center gap-2">
                      <Button 
                        variant="outline" 
                        size="sm"
                        onClick={() => handleEditNotification(notification)}
                      >
                        <Settings className="h-4 w-4 mr-1" />
                        Configurar
                      </Button>
                      <div className="flex items-center gap-2">
                        <span className={`${notification.active ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'} text-xs font-medium px-2.5 py-0.5 rounded-full`}>
                          {notification.active ? 'Ativo' : 'Desativado'}
                        </span>
                        <Button 
                          variant="ghost" 
                          size="icon" 
                          onClick={() => handleToggleActive(notification.id, notification.active)}
                        >
                          {notification.active ? 
                            <Bell className="h-4 w-4" /> : 
                            <BellOff className="h-4 w-4" />
                          }
                        </Button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </TabsContent>
          ))}

          <TabsContent value="templates">
            <div className="border rounded-md p-6 text-center">
              <h3 className="text-lg font-medium mb-2">Modelos Globais de Notificação</h3>
              <p className="text-muted-foreground mb-4">
                Personalize o aspecto e o conteúdo base de todas as notificações enviadas pela plataforma.
              </p>
              <Button>Gerenciar Modelos Globais</Button>
            </div>
          </TabsContent>
        </Tabs>
      </CardContent>

      {/* Dialog for editing notification */}
      {editingNotification && (
        <Dialog open={isDialogOpen} onOpenChange={handleCloseDialog}>
          <DialogContent className="sm:max-w-[600px]">
            <DialogHeader>
              <DialogTitle>Configurar Notificação: {editingNotification.title}</DialogTitle>
              <DialogDescription>
                Personalize as configurações desta notificação, seus canais de envio e destinatários.
              </DialogDescription>
            </DialogHeader>
            
            <div className="space-y-6 py-4">
              {/* Status toggle */}
              <div className="flex items-center justify-between">
                <div>
                  <h4 className="font-medium">Status da Notificação</h4>
                  <p className="text-sm text-muted-foreground">Ativar ou desativar esta notificação</p>
                </div>
                <div className="flex items-center">
                  <RadioGroup 
                    defaultValue={editingNotification.active ? "active" : "inactive"}
                    className="flex gap-4"
                  >
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="active" id="active" />
                      <FormLabel htmlFor="active" className="font-normal">Ativo</FormLabel>
                    </div>
                    <div className="flex items-center space-x-2">
                      <RadioGroupItem value="inactive" id="inactive" />
                      <FormLabel htmlFor="inactive" className="font-normal">Desativado</FormLabel>
                    </div>
                  </RadioGroup>
                </div>
              </div>
              
              {/* Notification channels */}
              <div>
                <h4 className="font-medium mb-2">Canais de Envio</h4>
                <p className="text-sm text-muted-foreground mb-4">
                  Selecione por quais canais esta notificação será enviada
                </p>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div className="flex items-start space-x-2">
                    <Checkbox 
                      id="channel-inapp" 
                      defaultChecked={editingNotification.channels.inApp} 
                    />
                    <div className="grid gap-1.5">
                      <FormLabel htmlFor="channel-inapp" className="font-normal">Notificação In-App</FormLabel>
                      <p className="text-sm text-muted-foreground">
                        Exibida dentro da plataforma
                      </p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-2">
                    <Checkbox 
                      id="channel-email" 
                      defaultChecked={editingNotification.channels.email} 
                    />
                    <div className="grid gap-1.5">
                      <FormLabel htmlFor="channel-email" className="font-normal">Email</FormLabel>
                      <p className="text-sm text-muted-foreground">
                        Enviada para o email do usuário
                      </p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-2">
                    <Checkbox 
                      id="channel-sms" 
                      defaultChecked={editingNotification.channels.sms} 
                    />
                    <div className="grid gap-1.5">
                      <FormLabel htmlFor="channel-sms" className="font-normal">SMS</FormLabel>
                      <p className="text-sm text-muted-foreground">
                        Enviada para o celular do usuário
                      </p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-2">
                    <Checkbox 
                      id="channel-chat" 
                      defaultChecked={editingNotification.channels.chatInternal} 
                    />
                    <div className="grid gap-1.5">
                      <FormLabel htmlFor="channel-chat" className="font-normal">Chat Interno</FormLabel>
                      <p className="text-sm text-muted-foreground">
                        Enviada para o chat interno
                      </p>
                    </div>
                  </div>
                  <div className="flex items-start space-x-2">
                    <Checkbox 
                      id="channel-push" 
                      defaultChecked={editingNotification.channels.push} 
                    />
                    <div className="grid gap-1.5">
                      <FormLabel htmlFor="channel-push" className="font-normal">Notificação Push</FormLabel>
                      <p className="text-sm text-muted-foreground">
                        Enviada para dispositivos móveis
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Recipients */}
              <div>
                <h4 className="font-medium mb-2">Destinatários</h4>
                <p className="text-sm text-muted-foreground mb-4">
                  Selecione quem receberá esta notificação
                </p>
                <div className="grid gap-4">
                  {editingNotification.recipients.map((recipient) => (
                    <div key={recipient} className="flex items-start space-x-2">
                      <Checkbox 
                        id={`recipient-${recipient}`} 
                        defaultChecked={true} 
                      />
                      <div className="grid gap-1.5">
                        <FormLabel 
                          htmlFor={`recipient-${recipient}`} 
                          className="font-normal"
                        >
                          {getRecipientLabel(recipient)}
                        </FormLabel>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              
              {/* Message templates */}
              <div>
                <h4 className="font-medium mb-2">Modelos de Mensagem</h4>
                <p className="text-sm text-muted-foreground mb-4">
                  Personalize o conteúdo da notificação para cada canal
                </p>
                <div className="space-y-2">
                  {editingNotification.channels.inApp && (
                    <Button variant="outline" className="w-full justify-start">
                      <span>Editar Modelo para Notificação In-App</span>
                    </Button>
                  )}
                  {editingNotification.channels.email && (
                    <Button variant="outline" className="w-full justify-start">
                      <span>Editar Modelo para Email</span>
                    </Button>
                  )}
                  {editingNotification.channels.sms && (
                    <Button variant="outline" className="w-full justify-start">
                      <span>Editar Modelo para SMS</span>
                    </Button>
                  )}
                  {editingNotification.channels.chatInternal && (
                    <Button variant="outline" className="w-full justify-start">
                      <span>Editar Modelo para Chat Interno</span>
                    </Button>
                  )}
                  {editingNotification.channels.push && (
                    <Button variant="outline" className="w-full justify-start">
                      <span>Editar Modelo para Push</span>
                    </Button>
                  )}
                </div>
              </div>
              
              {/* Configuration options specific to this notification type */}
              {editingNotification.id === "sla-first-response" && (
                <div>
                  <h4 className="font-medium mb-2">Configurações Específicas</h4>
                  <div className="space-y-4">
                    <div className="grid gap-2">
                      <FormLabel htmlFor="sla-time">Tempo antes do alerta</FormLabel>
                      <div className="flex gap-2">
                        <Input 
                          id="sla-time" 
                          type="number" 
                          defaultValue={15} 
                          className="w-24"
                        />
                        <Select defaultValue="minutes">
                          <SelectTrigger className="w-40">
                            <SelectValue placeholder="Selecione" />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="minutes">Minutos</SelectItem>
                            <SelectItem value="hours">Horas</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                      <p className="text-sm text-muted-foreground">
                        Tempo antes de notificar sobre SLA de primeira resposta.
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            <DialogFooter className="flex justify-between">
              <Button variant="outline" onClick={handleCloseDialog}>
                Cancelar
              </Button>
              <div className="flex gap-2">
                <Button variant="outline" onClick={() => console.log("Enviando teste...")}>
                  Enviar Teste
                </Button>
                <Button onClick={handleSaveNotification}>
                  Salvar Configurações
                </Button>
              </div>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      )}
    </Card>
  );
};
