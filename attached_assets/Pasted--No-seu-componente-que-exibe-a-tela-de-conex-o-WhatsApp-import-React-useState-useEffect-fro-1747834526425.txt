// No seu componente que exibe a tela de conexão WhatsApp
import React, { useState, useEffect } from 'react';
import { getZapiQRCode } from '../services/zapiService'; // Ajuste o caminho conforme necessário
import QRCodeDisplay from './QRCodeDisplay'; // Ajuste o caminho conforme necessário

function WhatsAppConnection({ channel }) {
  const [qrCodeData, setQrCodeData] = useState('');
  const [isImageQR, setIsImageQR] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleGetQRCode = async () => {
    try {
      setLoading(true);
      setError('');
      
      // Obtenha a configuração do canal
      const config = channel.configuration || {};
      const { instanceId, token, clientToken } = config;
      
      if (!instanceId || !token || !clientToken) {
        setError('Configuração incompleta. Verifique instanceId, token e clientToken.');
        setLoading(false);
        return;
      }
      
      // Chame a função para obter o QR code
      const result = await getZapiQRCode(instanceId, token, clientToken);
      
      if (result.success && result.qrCode) {
        console.log("QR Code obtido com sucesso:", {
          isImage: result.isImage,
          dataLength: result.qrCode.length
        });
        
        setQrCodeData(result.qrCode);
        setIsImageQR(result.isImage || false);
      } else {
        setError(result.message || 'Falha ao obter QR Code');
      }
    } catch (err) {
      console.error('Erro ao obter QR code:', err);
      setError('Erro ao obter QR Code: ' + (err.message || 'Erro desconhecido'));
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="whatsapp-connection">
      <h2>Conexão WhatsApp</h2>
      
      <button 
        onClick={handleGetQRCode} 
        disabled={loading}
        className="qrcode-button"
      >
        {loading ? 'Carregando...' : 'Gerar QR Code para Conexão'}
      </button>
      
      {error && (
        <div className="error-message">
          {error}
        </div>
      )}
      
      {qrCodeData && (
        <div className="qrcode-container">
          <h3>Escaneie com WhatsApp</h3>
          <QRCodeDisplay qrCodeData={qrCodeData} isImage={isImageQR} />
          <p className="qrcode-help">
            Abra o WhatsApp no seu celular, toque em Menu ou Configurações e selecione "WhatsApp Web". Escaneie este QR Code.
          </p>
        </div>
      )}
    </div>
  );
}

export default WhatsAppConnection;